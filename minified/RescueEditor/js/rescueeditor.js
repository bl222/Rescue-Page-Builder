/*
        Programmed By Benoit Lanteigne
        (c) Benoit Lanteigne, all rights reserved
        Licenced under GNU Affero General Public License 
    */
"use strict";function _possibleConstructorReturn(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},_slicedToArray=function(){function e(e,t){var r=[],l=!0,a=!1,s=void 0;try{for(var n,i=e[Symbol.iterator]();!(l=(n=i.next()).done)&&(r.push(n.value),!t||r.length!==t);l=!0);}catch(e){a=!0,s=e}finally{try{!l&&i.return&&i.return()}finally{if(a)throw s}}return r}return function(t,r){if(Array.isArray(t))return t;if(Symbol.iterator in Object(t))return e(t,r);throw new TypeError("Invalid attempt to destructure non-iterable instance")}}(),_createClass=function(){function e(e,t){for(var r=0;r<t.length;r++){var l=t[r];l.enumerable=l.enumerable||!1,l.configurable=!0,"value"in l&&(l.writable=!0),Object.defineProperty(e,l.key,l)}}return function(t,r,l){return r&&e(t.prototype,r),l&&e(t,l),t}}();String.prototype.blreReplaceAll||(String.prototype.blreReplaceAll=function(e,t){var r=this;return e instanceof RegExp||(e=e.replace(/([.*+?^=!:${}()|\[\]\/\\])/g,"\\$1"),e=RegExp(e,"g")),r.replace(e,t)});var BLRE={},BlreEventsManager=function(){function e(){_classCallCheck(this,e),this._events={}}return _createClass(e,[{key:"bind",value:function(e,t,r){this._events[e]={bindedData:r,callback:t}}},{key:"trigger",value:function(e,t){var r=this._events[e];return r.callback(t,r.bindedData)}},{key:"exists",value:function(e){return void 0!==this._events[e]}}]),e}();BLRE.events=new BlreEventsManager;var blreTmp=function(){var e={};BLRE.events.bind("blre-async-load-config",function(t){return BlreAjax.get(t.url).then(function(t){e=t},function(){console.log("Error! blre config loading failed")})}),BLRE.events.bind("blre-get-config-value",function(t){return e[t]})}(),BlreAjax=function(){function e(){_classCallCheck(this,e)}return _createClass(e,null,[{key:"request",value:function(e,t,r){return new Promise(function(l,a){var s=new XMLHttpRequest;s.onreadystatechange=function(){if(4===s.readyState)if(200===s.status)try{var t=JSON.parse(s.responseText);l(t)}catch(e){l(s.responseText)}else a(s.responseText+" "+e)},s.open(t,e),s.send(r)})}},{key:"get",value:function(t){return e.request(t,"GET")}},{key:"post",value:function(t,r){return e.request(t,"POST",r)}}]),e}(),BlreBasicGetUrlFormatter=function(){function e(t){_classCallCheck(this,e),this._idPattern="%id%"}return _createClass(e,[{key:"format",value:function(e,t){return t&&t.id&&(e=e.replace(this._idPattern,t.id)),e}}]),e}(),BlreBaseLoader=function(){function e(){_classCallCheck(this,e),this._cache={},this.urlFormatter=new BlreBasicGetUrlFormatter}return _createClass(e,[{key:"get",value:function(e){var t=this._getFromCache(e);return t?Promise.resolve([e,t]):this._getHelper(e)}},{key:"getMany",value:function(e){if(0===e.length)return Promise.resolve({});var t=[],r=!0,l=!1,a=void 0;try{for(var s,n=e[Symbol.iterator]();!(r=(s=n.next()).done);r=!0){var i=s.value;t.push(this.get(i))}}catch(e){l=!0,a=e}finally{try{!r&&n.return&&n.return()}finally{if(l)throw a}}return Promise.all(t).then(function(e){var t=_slicedToArray(e,2),r=(t[0],t[1],{}),l=!0,a=!1,s=void 0;try{for(var n,i=e[Symbol.iterator]();!(l=(n=i.next()).done);l=!0){var o=n.value,c=_slicedToArray(o,2),u=c[0],d=c[1];r[u]=d}}catch(e){a=!0,s=e}finally{try{!l&&i.return&&i.return()}finally{if(a)throw s}}return r})}},{key:"_getFromCache",value:function(e){return this._cache[e]}},{key:"_setToCache",value:function(e,t){this._cache[e]=t}},{key:"_getHelper",value:function(e){e=e||"default";var t=this.urlFormatter.format(BLRE.events.trigger("blre-get-config-value",this.configUrlKey),{id:e}),r=this;return BlreAjax.get(t).then(function(t){return r._setToCache(e,t),[e,t]},function(e){console.log("ajax call failed! "+e)})}}]),e}(),BlreBaseSaverLoader=function(e){function t(){return _classCallCheck(this,t),_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this))}return _inherits(t,BlreBaseLoader),_createClass(t,[{key:"post",value:function(e){var t=this.urlFormatter.format(BLRE.events.trigger("blre-get-config-value",this.configPostUrlKey));return BlreAjax.post(t,e)}}]),t}(),BlreHtmlBlockLoader=function(e){function t(){_classCallCheck(this,t);var e=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return e.configUrlKey="blockUrl",e}return _inherits(t,BlreBaseLoader),t}();blreTmp=function(){var e=new BlreHtmlBlockLoader;BLRE.events.bind("blre-async-io-get-html-block",function(t){return e.get(t.id,t.callback).then(function(e){return e[1]})}),BLRE.events.bind("blre-async-io-get-many-html-blocks",function(t){return e.getMany(t.ids,t.callback)})}();var BlreListsHtmlBlocksLoader=function(e){function t(){_classCallCheck(this,t);var e=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return e.configUrlKey="listBlockUrl",e}return _inherits(t,BlreBaseLoader),t}();blreTmp=function(){var e=new BlreListsHtmlBlocksLoader;BLRE.events.bind("blre-async-io-get-list-html-blocks",function(t){return e.get(t.id).then(function(e){return e[1]})})}();var BaseTemplateHandler=function(){function e(){_classCallCheck(this,e)}return _createClass(e,[{key:"renderTemplate",value:function(e,t){var r=e;for(var l in t){var a="{{{"+l+"}}}",s=new RegExp(a,"g");r=r.replace(s,t[l])}return r}}]),e}(),BlreHtmlTemplateHandler=function(e){function t(){_classCallCheck(this,t);var e=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return e._selectors={baseId:"blre-block-",classes:{block:"blre-block",root:"blre-root",hasChildren:"blre-has-children",editable:"blre-editable",deletable:"blre-deletable",loader:"blre-block-loader"},attributes:{allowedChildrenList:"data-blre-allowed-children",blockType:"data-blre-block-type",isTag:"data-blre-is-tag",loadBloc:"data-load-block"}},e._blreML={tags:{block:"block",content:"content",editor:"editor",defaults:"defaults",default:"default",children:"children",loadBlock:"loadblock"},attributes:{block:"block",validChildren:"valid-children",noAdd:"no-add",noEdit:"no-edit",noDelete:"no-delete"}},e}return _inherits(t,BaseTemplateHandler),_createClass(t,[{key:"renderHtml",value:function(e,t){var r=this._translateBlreML(e,t),l=_slicedToArray(r,2),a=l[0],s=l[1],n=this._getBlockDefaultValues(s);return{html:this.renderTemplate(a,n),templateData:{template:a,jsonArray:n}}}},{key:"addNewBlock",value:function(e,t,r,l){var a=this;return BLRE.events.trigger("blre-async-templating-render-html-block",{blockType:e}).then(function(e){return new Promise(function(l,s){var n=BLRE.events.trigger("blre-html-persistance-add-new-node",{html:e.html,templateData:e.templateData,parentId:t,index:r}),i=a._convertHtmlToDomNodeList(e.templateData.template.trim())[0],o=a._getBlocksToLoad(i);BLRE.events.trigger("blre-async-io-get-many-html-blocks",{ids:o}).then(function(e){var t=i.getAttribute("id").replace(a._selectors.baseId,""),r=t,s=Array.from(i.querySelectorAll("."+a._selectors.classes.block)),o=!0,c=!1,u=void 0;try{for(var d,h=s[Symbol.iterator]();!(o=(d=h.next()).done);o=!0){var b=d.value,v=b.closest(".blre-processed")?r:t,f=a._createChildForNewBlock(b,e),m=BLRE.events.trigger("blre-html-persistance-add-new-node",{html:f.html,templateData:f.templateData,parentId:v});b.classList.add("blre-processed"),r=m.globalId}}catch(e){c=!0,u=e}finally{try{!o&&h.return&&h.return()}finally{if(c)throw u}}var p=BLRE.events.trigger("blre-html-persistance-render-node-html",{blockId:n.globalId});l([n.globalId,p,n.parentId])})})})}},{key:"getBlockEditForm",value:function(e,t,r){var l=this,a=BLRE.events.trigger("blre-html-persistance-get-node-template-data",{blockId:e});return BLRE.events.trigger("blre-async-io-get-html-block",{id:t}).then(function(e){var t=l._convertHtmlToDomNodeList(e)[0].querySelector(l._blreML.tags.editor).innerHTML;return l.renderTemplate(t,a.jsonArray)})}},{key:"applyEditsToBlock",value:function(e,t){for(var r=BLRE.events.trigger("blre-html-persistance-get-node-template-data",{blockId:e}),l={},a=t,s=0;s<a.length;++s)l[a[s].name]=a[s].value;var n=this.renderTemplate(r.template,l);return BLRE.events.trigger("blre-html-persistance-update-node",{blockId:e,html:n,templateData:{template:r.template,jsonArray:l}}),BLRE.events.trigger("blre-html-persistance-render-node-html",{blockId:e})}},{key:"getRootHtml",value:function(){return Promise.resolve('<div id="'+this._selectors.baseId+'1" class="'+this._selectors.classes.block+" "+this._selectors.classes.root+" "+this._selectors.classes.hasChildren+'">\n\n                            \x3c!--[[[--\x3e\x3c!--]]]--\x3e\n \n                    </div>')}},{key:"insertChildrenHtml",value:function(e,t){return e.replace(/<!--\[\[\[-->[\s\S]*<!--\]\]\]-->/g,t)}},{key:"_convertHtmlToDomNodeList",value:function(e){e=e.trim();var t=document.createElement("div");if(e.startsWith("<tr")){var r=document.createElement("table");t=document.createElement("tbody"),r.appendChild(t)}else if(e.startsWith("<td")){var l=document.createElement("table"),a=document.createElement("tbody");t=document.createElement("tr"),l.appendChild(a),a.appendChild(t)}return t.innerHTML=e,t.childNodes}},{key:"_translateBlreML",value:function(e,t){e=(e=(e=(e=(e=(e=(e=(e=(e=(e=e.trim()).blreReplaceAll("<"+this._blreML.tags.content,'<span class="blre-template" ').blreReplaceAll("</"+this._blreML.tags.content+">","</span>")).blreReplaceAll("<"+this._blreML.tags.children+">",'<span class="blre-children">&amp;&amp;&amp;').blreReplaceAll("</"+this._blreML.tags.children+">","</span><span>&&&</span>")).blreReplaceAll("<"+this._blreML.tags.loadBlock,'<span class="'+this._selectors.classes.block+" "+this._selectors.classes.blockLoader+'" ').blreReplaceAll("</"+this._blreML.tags.loadBlock+">","</span>")).blreReplaceAll("<table","<div "+this._selectors.attributes.isTag+'="table" ').blreReplaceAll("</table>","</div>")).blreReplaceAll("<tbody","<div "+this._selectors.attributes.isTag+'="tbody" ').blreReplaceAll("</tr>","</div>")).blreReplaceAll("<thead","<div "+this._selectors.attributes.isTag+'="thead" ').blreReplaceAll("</tr>","</div>")).blreReplaceAll("<tr","<div "+this._selectors.attributes.isTag+'="tr" ').blreReplaceAll("</tr>","</div>")).blreReplaceAll("<td","<div "+this._selectors.attributes.isTag+'="td" ').blreReplaceAll("</td>","</div>")).blreReplaceAll("<th","<div "+this._selectors.attributes.isTag+'="th" ').blreReplaceAll("</tr>","</div>");var r=this._convertHtmlToDomNodeList(e)[0];this._translateAttributes(r,t);var l=r.outerHTML;l=l.blreReplaceAll(/<span class="blre-children"[\s\S]*?>&amp;&amp;&amp;/g,"\x3c!--[[[--\x3e").blreReplaceAll("</span><span>&amp;&amp;&amp;</span>","\x3c!--]]]--\x3e");var a=this._convertHtmlToDomNodeList(l)[0];return this._replaceTags(a),l=a.querySelector(".blre-template").innerHTML,[l.trim(),a]}},{key:"_translateAttributes",value:function(e,t){var r=e.querySelector(".blre-template"),l=r.querySelector("*");l.setAttribute("id",this._selectors.baseId+BLRE.events.trigger("blre-html-persistance-preview-next-global-id")),l.setAttribute(this._selectors.attributes.blockType,t);var a=Array.from(e.querySelectorAll("."+this._selectors.classes.blockLoader)),s=!0,n=!1,i=void 0;try{for(var o,c=a[Symbol.iterator]();!(s=(o=c.next()).done);s=!0){var u=o.value;u.setAttribute(this._selectors.attributes.loadBlock,u.getAttribute(this.blreML.attributes.block)),u.removeAttribute(this.blreML.attributes.block)}}catch(e){n=!0,i=e}finally{try{!s&&c.return&&c.return()}finally{if(n)throw i}}if(l.classList.add(this._selectors.classes.block),r.hasAttribute(this._blreML.attributes.noEdit)||l.classList.add(this._selectors.classes.editable),r.hasAttribute(this._blreML.attributes.noDelete)||l.classList.add(this._selectors.classes.deletable),!r.hasAttribute(this._blreML.attributes.noAdd)){var d=r.querySelector(".blre-children");d&&d.parentNode.classList.add(this._selectors.classes.hasChildren)}r.hasAttribute(this._blreML.attributes.validChildren)&&l.setAttribute(this._selectors.attributes.allowedChildrenList,r.getAttribute(this._blreML.attributes.validChildren))}},{key:"_replaceTags",value:function(e){var t=Array.from(e.querySelectorAll("["+this._selectors.attributes.isTag+"]")).reverse(),r=!0,l=!1,a=void 0;try{for(var s,n=t[Symbol.iterator]();!(r=(s=n.next()).done);r=!0){var i=s.value,o=i.getAttribute(this._selectors.attributes.isTag),c=document.createElement(o),u=i.attributes,d=!0,h=!1,b=void 0;try{for(var v,f=u[Symbol.iterator]();!(d=(v=f.next()).done);d=!0){var m=v.value;c.setAttribute(m.name,m.value)}}catch(e){h=!0,b=e}finally{try{!d&&f.return&&f.return()}finally{if(h)throw b}}c.removeAttribute(this._selectors.attributes.isTag),c.innerHTML=i.innerHTML,i.parentNode.replaceChild(c,i)}}catch(e){l=!0,a=e}finally{try{!r&&n.return&&n.return()}finally{if(l)throw a}}}},{key:"_getBlockDefaultValues",value:function(e){var t={},r=Array.from(e.querySelectorAll(this._blreML.tags.default)),l=!0,a=!1,s=void 0;try{for(var n,i=r[Symbol.iterator]();!(l=(n=i.next()).done);l=!0){var o=n.value;t[o.getAttribute("key")]=o.textContent}}catch(e){a=!0,s=e}finally{try{!l&&i.return&&i.return()}finally{if(a)throw s}}return t}},{key:"_getBlocksToLoad",value:function(e){var t=[],r=Array.from(e.querySelectorAll("."+this._selectors.classes.blockLoader)),l=!0,a=!1,s=void 0;try{for(var n,i=r[Symbol.iterator]();!(l=(n=i.next()).done);l=!0){var o=n.value.getAttribute(this._selectors.attributes.loadBlock);r.indexOf(o)<0&&t.push(o)}}catch(e){a=!0,s=e}finally{try{!l&&i.return&&i.return()}finally{if(a)throw s}}return t}},{key:"_createChildForNewBlock",value:function(e,t){var r=e.getAttribute(this._selectors.attributes.loadBlock);return r?htmlTemplateHandler.renderHtml(t[r],r):this._createInlineBlock(e)}},{key:"_createInlineBlock",value:function(e){e.setAttribute("id",this._selectors.baseId+BLRE.events.trigger("blre-html-persistance-preview-next-global-id"));var t=e.closest(this.blreML.tags.block);return htmlTemplateHandler.renderHtml(t.outerHTML,"unknown-block")}}]),t}();blreTmp=function(){var e=new BlreHtmlTemplateHandler;BLRE.events.bind("blre-async-templating-render-html-block",function(t){return BLRE.events.trigger("blre-async-io-get-html-block",{id:t.blockType}).then(function(r){return e.renderHtml(r,t.blockType)})}),BLRE.events.bind("blre-async-templating-add-new-block",function(t){return e.addNewBlock(t.blockType,t.parentId,t.index)}),BLRE.events.bind("blre-async-templating-get-block-edit-form",function(t){return e.getBlockEditForm(t.blockId,t.blockType)}),BLRE.events.bind("blre-templating-apply-edits-to-block-html",function(t){return e.applyEditsToBlock(t.blockId,t.formData)}),BLRE.events.bind("blre-async-templating-get-root-html",function(){return e.getRootHtml()}),BLRE.events.bind("blre-templating-insert-children-into-html",function(t){return e.insertChildrenHtml(t.html,t.childrenHtml)}),BLRE.events.bind("blre-event-get-templating-selectors",function(){return e._selectors})}();var BlreCompositeLeafNode=function(){function e(){_classCallCheck(this,e),this.parent=void 0,this.globalId=e.nextGlobalId(),this.depth=0}return _createClass(e,[{key:"is",value:function(e){e[e.length-1].isParent=!0;var t=this._makeAncestorsArray();t.unshift(this);for(var r=0,l=e.length-1;l>=0;--l){if(e[l].isParent){if(!t[r]._match(e,l))return!1}else{for(;r<t.length&&!t[r]._match(e,l);++r);if(r>=t.length)return!1}++r}return!0}},{key:"ancestors",value:function(e){e=e||[{}];for(var t=[],r=this.parent;void 0!==r;r=r.parent)r.is(e)&&t.push(r);return t}},{key:"ancestor",value:function(e){e=e||[{}];for(var t=this.parent;void 0!==t;t=t.parent)if(t.is(e))return t}},{key:"breathTraveral",value:function(e){e.maxDepth=void 0===e.maxDepth?Number.MAX_SAFE_INTEGER:e.maxDepth,e.maxDepth+=this.depth;var t=[];if(e.excludeRoot){if(!this.children)return;t=t.concat(this.children)}else t.push(this);for(;t.length>0;){var r=t.shift();if(!(r.children&&r.depth<e.maxDepth)||e.lowest&&r.is(e.lowest)||(t=t.concat(r.children)),e.callback&&e.callback(r,e))return}}},{key:"depthTraversal",value:function(e){if(e.callback&&e.callback(this,e),this.children)for(var t=0;t<this.children.length;++t)this.children[t].depthTraversal(e);e.callbackPost&&e.callbackPost(this,e)}},{key:"find",value:function(e,t){var r=[];return!1!==(t=t||{}).excludeRoot&&(t.excludeRoot=!0),t.callback=function(t){t.is(e)&&r.push(t)},this.breathTraveral(t),r}},{key:"children",value:function(e,t){return t=t||{},t.maxDepth=0,this.find(e,t)}},{key:"findFirst",value:function(e,t){var r=void 0;return!1!==(t=t||{}).excludeRoot&&(t.excludeRoot=!1),t.callback=function(t){if(t.is(e))return r=t,!0},this.breathTraveral(t),r}},{key:"firstChild",value:function(e,t){return t=t||{},t.maxDepth=0,this.findFirst(e,t)}},{key:"getGreatestGlobalId",value:function(){var e={excludeRoot:!1},t=0;return e.callback=function(e){e.globalId>t&&(t=e.globalId)},this.breathTraveral(e),t}},{key:"_match",value:function(t,r){var l=!0,a=!0,s=!1,n=void 0;try{for(var i,o=e._matchers[Symbol.iterator]();!(a=(i=o.next()).done);a=!0){var c=i.value;if(!(l=l&&c(this,t,r)))return!1}}catch(e){s=!0,n=e}finally{try{!a&&o.return&&o.return()}finally{if(s)throw n}}return!0}},{key:"_makeAncestorsArray",value:function(){for(var e=[],t=this.parent;void 0!==t;t=t.parent)e.push(t);return e}}],[{key:"nextGlobalId",value:function(){return e._nGId++}},{key:"setGlobalId",value:function(t){e._nGId=t}}]),e}();BlreCompositeLeafNode._nGId=1,BlreCompositeLeafNode._matchers=[],BlreCompositeLeafNode._matchers.push(function(e,t,r){return!t[r].gId||e.globalId==t[r].gId});var BlreCompositeNode=function(e){function t(){_classCallCheck(this,t);var e=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return e.children=[],e}return _inherits(t,BlreCompositeLeafNode),_createClass(t,[{key:"addChild",value:function(e,t){e.depth=this.depth+1,t||0===t?this.children.splice(t,0,e):this.children.push(e),e.parent=this}},{key:"getChildIndex",value:function(e){for(var t=0;t<this.children.length;++t)if(this.children[t].globalId===e.globalId)return t}},{key:"removeChild",value:function(e){var t=this.getChildIndex(e);return t<this.children.length&&(this.children.splice(t,1),!0)}},{key:"removeChildFromIndex",value:function(e){return a_index<this.children.length&&(this.children.splice(a_index,1),!0)}}]),t}(),BlreHtmlBuilderNode=function(e){function t(e,r){_classCallCheck(this,t);var l=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return l.html=e||"",l.templateData=r,l}return _inherits(t,BlreCompositeNode),_createClass(t,[{key:"renderHtml",value:function(){var e=this.html,t="",r=!0,l=!1,a=void 0;try{for(var s,n=this.children[Symbol.iterator]();!(r=(s=n.next()).done);r=!0)t+=s.value.renderHtml()}catch(e){l=!0,a=e}finally{try{!r&&n.return&&n.return()}finally{if(l)throw a}}return e=BLRE.events.trigger("blre-templating-insert-children-into-html",{html:e,childrenHtml:t})}},{key:"serializeXml",value:function(){function e(t){var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"";r+="<node>",r+="<htmlvalue>"+t.html+"</htmlvalue>",r+="<globalid>"+t.globalId+"</globalid>",r+="<templatedata>";for(var l in t.templateData){r+="<"+l+' data-key="'+l+'">';var a=t.templateData[l];"object"===(void 0===a?"undefined":_typeof(a))?r+=JSON.stringify(a):r+=a,r+="</"+l+">"}r+="</templatedata>",r+="<children>";var s=!0,n=!1,i=void 0;try{for(var o,c=t.children[Symbol.iterator]();!(s=(o=c.next()).done);s=!0)r+=e(o.value)}catch(e){n=!0,i=e}finally{try{!s&&c.return&&c.return()}finally{if(n)throw i}}return r+="</children></node>"}var t=e(this);return JSON.stringify(t)}},{key:"deserializeXml",value:function(e){function r(e,l){e.html=l.querySelector("htmlvalue").innerHTML,e.globalId=parseInt(l.querySelector("globalid").innerHTML),e.templateData={};var a=l.querySelector("templatedata"),s=!0,n=!1,i=void 0;try{for(var o,c=a.children[Symbol.iterator]();!(s=(o=c.next()).done);s=!0){var u=o.value,d=u.innerHTML,h=u.getAttribute("data-key");try{e.templateData[h]=JSON.parse(d)}catch(t){e.templateData[h]=d}}}catch(e){n=!0,i=e}finally{try{!s&&c.return&&c.return()}finally{if(n)throw i}}var b=l.querySelector("children");if(b){var v=!0,f=!1,m=void 0;try{for(var p,y=b.children[Symbol.iterator]();!(v=(p=y.next()).done);v=!0){var g=p.value,_=new t;e.addChild(_),r(_,g)}}catch(e){f=!0,m=e}finally{try{!v&&y.return&&y.return()}finally{if(f)throw m}}}return e}return r(this,(new DOMParser).parseFromString(e,"text/html"))}}]),t}();blreTmp=function(){var e=void 0;BLRE.events.bind("blre-async-html-persistance-create-root",function(t){return BLRE.events.trigger("blre-async-templating-get-root-html").then(function(t){return e=new BlreHtmlBuilderNode(t),[e.globalId,e.renderHtml()]})}),BLRE.events.bind("blre-html-persistance-add-new-node",function(t){var r=new BlreHtmlBuilderNode(t.html,t.templateData);return e.findFirst([{gId:t.parentId}],{excludeRoot:!1}).addChild(r,t.index),{globalId:r.globalId,html:r.renderHtml()}}),BLRE.events.bind("blre-html-persistance-get-node-template-data",function(t){return e.findFirst([{gId:t.blockId}]).templateData}),BLRE.events.bind("blre-html-persistance-update-node",function(t){var r=e.findFirst([{gId:t.blockId}],{excludeRoot:!1});r.html=t.html,r.templateData=t.templateData}),BLRE.events.bind("blre-html-persistance-render-node-html",function(t){return e.findFirst([{gId:t.blockId}],{excludeRoot:!1}).renderHtml()}),BLRE.events.bind("blre-html-persistance-preview-next-global-id",function(e){return BlreCompositeLeafNode._nGId}),BLRE.events.bind("blre-html-persistance-delete-node",function(t){var r=e.findFirst([{gId:t.blockId}]);r.parent.removeChild(r)}),BLRE.events.bind("blre-html-persistance-serialize",function(t){return e.serializeXml()}),BLRE.events.bind("blre-html-persistance-deserialize",function(t){var r=(e=new BlreHtmlBuilderNode).deserializeXml(t.toLoad),l=e.getGreatestGlobalId()+1;return BlreCompositeLeafNode.setGlobalId(l),r})}();var BluiBase=function(){function e(t){var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},l=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};_classCallCheck(this,e),this._dom=t,this._body=t.closest("body"),this._options=Object.assign(r,l)}return _createClass(e,[{key:"dom",value:function(){return this._dom}},{key:"_ajaxInit",value:function(){}}],[{key:"show",value:function(e){return e.style.display="",e.removeAttribute("data-hidden"),Promise.resolve()}},{key:"hide",value:function(e){return e.style.display="none",e.setAttribute("data-hidden",!0),Promise.resolve()}},{key:"prevAll",value:function(e,t){for(var r=[];e=e.previousElementSibling;)e.matches&&e.matches(t)&&r.push(e);return r}},{key:"nextAll",value:function(e,t){for(var r=[];e=e.nextElementSibling;)e.matches(t)&&r.push(e);return r}},{key:"trigger",value:function(e,t){var r=void 0;window.Event?r=new Event(t):(r=document.createEvent("HTMLEvents")).HTMLEvents(t,!0,!1),e.dispatchEvent(r)}},{key:"triggerCustom",value:function(e,t,r){var l=void 0;window.CustomEvent?l=new CustomEvent(t,{detail:r}):(l=document.createEvent("CustomEvent")).initCustomEvent(t,!0,!0,r),e.dispatchEvent(l)}},{key:"parseHtml",value:function(e){e=e.trim();var t=document.createElement("div");if(e.startsWith("<tr")){var r=document.createElement("table");t=document.createElement("tbody"),r.appendChild(t)}else if(e.startsWith("<td")){var l=document.createElement("table"),a=document.createElement("tbody");t=document.createElement("tr"),l.appendChild(a),a.appendChild(t)}t.innerHTML=e;var s=t.children;return s.length>1?s:1===s.length?s[0]:void 0}}]),e}(),BlUiDialog=function(e){function t(e){var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};_classCallCheck(this,t);var l={modal:!0},a=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e,r,l));return a._selectors={classes:{dialog:"blui-dialog",topmost:"blui-dialog-topmost",focusableProcessed:"blui-dialog-focusable-processed",overlay:"blui-dialog-overlay",closeButton:"blui-close"},attributes:{tmpTabindex:"data-blui-tabindex-tmp"}},a._events={opening:"blui-event-dialog-opening",opened:"blui-event-dialog-opened",closing:"blui-event-dialog-closing",closed:"blui-event-dialog-closed",creating:"blui-event-dialog-creating",created:"blui-event-dialog-created"},BluiBase.triggerCustom(a._dom,a._events.creating,{ui:a}),a._content=e.querySelector(".blui-dialog-content"),a._overlay=BluiBase.parseHtml('<div class="'+a._selectors.classes.overlay+'"></div>'),a._body.appendChild(a._overlay),BluiBase.hide(a._overlay),a._dom.classList.add(a._selectors.classes.dialog),a._dom.addEventListener("click",function(e){e.target&&e.target.matches("."+a._selectors.classes.closeButton)&&(e.preventDefault(),e.stopPropagation(),a.close())}),window.addEventListener("resize",function(e){a._repositionDialog()}),BluiBase.hide(a._dom),BluiBase.triggerCustom(a._dom,a._events.created,{ui:a}),a}return _inherits(t,BluiBase),_createClass(t,[{key:"open",value:function(){var e=this;BluiBase.triggerCustom(this._dom,this._events.opening,{ui:this});var t=1e5,r=this._body.querySelector("."+this._selectors.classes.topmost);r&&(t=parseInt(r.style.zIndex),r.classList.remove(this._selectors.classes.topmost)),this._dom.classList.add(this._selectors.classes.topmost),this._dom.style.zIndex=t+2,this._options.modal&&(this._overlay.style.zIndex=t+1,BluiBase.show(this._overlay),this._removeFocus()),this._repositionDialog(),this._returnFocus(this._dom),BluiBase.show(this._dom).then(function(){return BluiBase.triggerCustom(e._dom,e._events.opened,{ui:e}),BluiBase.trigger(window,"resize"),Promise.resolve()})}},{key:"close",value:function(){var e=this;return BluiBase.triggerCustom(this._dom,this._events.closing,{ui:this}),BluiBase.hide(this._dom).then(function(){e._dom.classList.remove(e._selectors.classes.topmost);var t=e._getTopmostDialogDom();t?t.classList.add(e._selectors.classes.topmost):t=e._body,e._returnFocus(t),BluiBase.hide(e._overlay),BluiBase.triggerCustom(e._dom,e._events.closed,{ui:e})})}},{key:"setContent",value:function(e){"string"==typeof e?this._content.innerHTML=e:(this._content.innerHTML="",this._content.appendChild(e))}},{key:"_getTopmostDialogDom",value:function(){var e=Array.from(this._body.querySelectorAll("."+this._selectors.classes.dialog+":not([hidden])")),t=this._body.querySelector("."+this._selectors.classes.dialog+":not([hidden])"),r=!0,l=!1,a=void 0;try{for(var s,n=e[Symbol.iterator]();!(r=(s=n.next()).done);r=!0){var i=s.value,o=parseInt(i.style.zIndex);parseInt(t.style.zIndex)>o&&(t=i)}}catch(e){l=!0,a=e}finally{try{!r&&n.return&&n.return()}finally{if(l)throw a}}return t}},{key:"_removeFocus",value:function(){var e=Array.from(this._body.querySelectorAll("a[href], area[href], input:not([disabled]), select:not([disabled]), textarea:not([disabled]), button:not([disabled]), iframe, object, embed, *[tabindex], *[contenteditable]")),t=!0,r=!1,l=void 0;try{for(var a,s=e[Symbol.iterator]();!(t=(a=s.next()).done);t=!0){var n=a.value;!n.matches("."+this._selectors.classes.focusableProcessed)&&n.closest("."+this._selectors.classes.topmost)&&n.closest("."+this._selectors.classes.dialog+"[data-hidden]").length<=0&&(n.matches("*[tabindex]")&&n.setAttribute(this._selectors.attributes.tmpTabindex,n.getAttribute("tabindex")),n.setAttribute("tabindex",-1),n.classList.add(this._selectors.classes.focusableProcessed))}}catch(e){r=!0,l=e}finally{try{!t&&s.return&&s.return()}finally{if(r)throw l}}}},{key:"_returnFocus",value:function(e){var t=Array.from(e.querySelectorAll(this._selectors.classes.focusableProcessed)),r=!0,l=!1,a=void 0;try{for(var s,n=t[Symbol.iterator]();!(r=(s=n.next()).done);r=!0){var i=s.value;i.matches("*[tabindex=-1]")&&i.removeAttribute("tabindex"),i.matches("["+this._selectors.attributes.tmpTabindex+"]")&&(i.setAttribute("tabindex",i.getAttribute(this._selectors.attributes.tmpTabindex)),i.removeAttribute(this._selectors.attributes.tmpTabindex)),i.classList.remove(this._selectors.classes.focusableProcessed)}}catch(e){l=!0,a=e}finally{try{!r&&n.return&&n.return()}finally{if(l)throw a}}}},{key:"_repositionDialog",value:function(){var e=(window.innerWidth-this._dom.offsetWidth)/2,t=0;t=(window.innerHeight-this._dom.offsetHeight)/2,e=e>0?e:0,t=t>0?t:100,this._dom.style.top=t+window.scrollY+"px",this._dom.style.left=e+"px"}}]),t}(),BlreRescueUi=function(e){function t(e){var r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};_classCallCheck(this,t);var l=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e,r,{})),a=BluiBase.parseHtml('\n                                        <div>\n                                            <a href="#" class="blui-close">X</a>\n                                            <div class="blui-dialog-content"></div>\n                                        </div>\n                                     ');return l._body.appendChild(a),l._dialog=new BlUiDialog(a),l._domData=new Map,l._blockIdBase="blre-block-",l._selectors=BLRE.events.trigger("blre-event-get-templating-selectors"),l._selectors.classes=Object.assign(l._selectors.classes,{addButton:"blre-add-button",editButton:"blre-edit-button",deleteButton:"blre-delete-button",blockSelectedToAddButton:"blre-selected-to-add-button",blockLabel:"blre-block-label",fakeSubmit:"blui-fake-submit"}),l._clickedAddButtonDom=void 0,l._dom.addEventListener("click",function(e){if(e.target)if(e.target.matches("."+l._selectors.classes.addButton)){e.preventDefault(),e.stopPropagation();var t=e.target;(t=t.closest("."+l._selectors.classes.hasChildren)).matches("."+l._selectors.classes.block)||(t=t.closest("."+l._selectors.classes.block)),l.showBlockSelectionDialog(t,e.target)}else if(e.target.matches("."+l._selectors.classes.editButton)){e.preventDefault(),e.stopPropagation();var r=e.target.closest("."+l._selectors.classes.block);l.showEditDialog(r)}else if(e.target.matches("."+l._selectors.classes.deleteButton)){e.preventDefault(),e.stopPropagation();var a=e.target.closest("."+l._selectors.classes.block);l.deleteBlock(a)}}),l._dialog.dom().addEventListener("click",function(e){if(e.preventDefault(),e.stopPropagation(),e.target)if(e.target.matches("."+l._selectors.classes.blockSelectedToAddButton)){var t=e.target;t.matches("a["+l._selectors.attributes.blockType+"]")||(t=t.closest("a["+l._selectors.attributes.blockType+"]"));var r=t.getAttribute(l._selectors.attributes.blockType),a=l._clickedAddButtonDom.closest("."+l._selectors.classes.block);l.addBlock(r,a,l._clickedAddButtonDom)}else if(e.target.matches("."+l._selectors.classes.fakeSubmit)){e.preventDefault(),e.stopPropagation();var s=l._dialog.dom().getElementsByTagName("form")[0],n=l._prepareEditFormValues(s),i=s.getAttribute("data-edited-block-id");l.editBlock(document.getElementById(i),n)}}),l}return _inherits(t,BluiBase),_createClass(t,[{key:"_ajaxInit",value:function(){var e=this;return BLRE.events.trigger("blre-async-html-persistance-create-root").then(function(t){var r=_slicedToArray(t,2),l=r[0],a=r[1],s=BluiBase.parseHtml(a);s.setAttribute("id",e._blockIdBase+l),e._dom.appendChild(s),e._blockify(s,!1)})}},{key:"showBlockSelectionDialog",value:function(e,t){var r=this,l=(e=e).getAttribute(this._selectors.attributes.allowedChildrenList);BLRE.events.trigger("blre-async-io-get-list-html-blocks",{id:l}).then(function(e){var l="<ul>";for(var a in e)for(var s in e[a])l+='<li>\n                                            <a href="" class="'+r._selectors.classes.blockSelectedToAddButton+'" '+r._selectors.attributes.blockType+'="'+s+'">'+s+"</a>\n                                          </li>";l+="</ul>",r._clickedAddButtonDom=t,r._dialog.setContent(l),r._dialog.open()})}},{key:"addBlock",value:function(e,t,r){var l=this;return this._dialog.close(),BLRE.events.trigger("blre-async-templating-add-new-block",{blockType:e,parentId:this._extractGlobalId(t),index:this._getAddButtonIndex(r)}).then(function(t){var a=_slicedToArray(t,3),s=(a[0],a[1]),n=(a[2],BluiBase.parseHtml(s));r.insertAdjacentHTML("beforebegin",n.outerHTML),l._blockify(r.previousElementSibling);var i="blre-block-added-"+e;if(BLRE.events.exists(i))BLRE.events.trigger(i,{blockDom:n});l._fireActionEvent()})}},{key:"showEditDialog",value:function(e){var t=this,r=this._extractGlobalId(e);return BLRE.events.trigger("blre-async-templating-get-block-edit-form",{blockId:r,blockType:e.getAttribute(this._selectors.attributes.blockType)}).then(function(r){t._dialog.open();var l=BluiBase.parseHtml(r),a=Array.from(l.querySelectorAll("[type=submit]")),s=!0,n=!1,i=void 0;try{for(var o,c=a[Symbol.iterator]();!(s=(o=c.next()).done);s=!0){var u=o.value;u.parentNode.removeChild(u)}}catch(e){n=!0,i=e}finally{try{!s&&c.return&&c.return()}finally{if(n)throw i}}l.appendChild(BluiBase.parseHtml('<input type="button" class="'+t._selectors.classes.fakeSubmit+'" value="submit"/>')),l.setAttribute("data-edited-block-id",e.getAttribute("id")),t._dialog.setContent(l.outerHTML),l=t._dialog._dom.getElementsByTagName("form")[0];var d=Array.from(l.querySelectorAll("input, textarea")),h=!0,b=!1,v=void 0;try{for(var f,m=d[Symbol.iterator]();!(h=(f=m.next()).done);h=!0){var p=f.value,y="blre-form-input-init-"+(p.matches("textarea")&&!p.getAttribute("type")?"textarea":p.getAttribute("type"));if(BLRE.events.exists(y)){var g=BLRE.events.trigger(y,{input:p});t._domData.set(t._dom,{"blre-form-input-custom-data":g})}}}catch(e){b=!0,v=e}finally{try{!h&&m.return&&m.return()}finally{if(b)throw v}}})}},{key:"editBlock",value:function(e,t){var r="blre-block-before-edit-"+e.getAttribute(this._selectors.attributes.blockType);if(BLRE.events.exists(r))BLRE.events.trigger(r,{blockDom:e,formData:t});var l=BLRE.events.trigger("blre-templating-apply-edits-to-block-html",{blockId:this._extractGlobalId(e),formData:t}),a=BluiBase.parseHtml(l);a.setAttribute(this._selectors.attributes.blockType,e.getAttribute(this._selectors.attributes.blockType)),e.insertAdjacentHTML("beforebegin",a.outerHTML),a=e.previousElementSibling,e.parentNode.removeChild(e),this._blockify(a,!1),this._dialog.close(),this._fireActionEvent()}},{key:"deleteBlock",value:function(e){if(confirm("Are you sure you want to delete this block?")){var t="blre-block-remove-"+e.getAttribute(this._selectors.attributes.blockType);if(BLRE.events.exists(t))BLRE.events.trigger(t,{blockDom:e});BLRE.events.trigger("blre-html-persistance-delete-node",{blockId:this._extractGlobalId(e)});var r=BluiBase.prevAll(e,"."+this._selectors.classes.addButton)[0];return r.parentNode.removeChild(r),e.parentNode.removeChild(e),this._fireActionEvent(),!0}return!1}},{key:"getFinalHtml",value:function(){var e=this._dom.querySelector("."+this._selectors.classes.root),t=BLRE.events.trigger("blre-html-persistance-render-node-html",{blockId:this._extractGlobalId(e)}),r=BluiBase.parseHtml(t),l=Array.from(r.querySelectorAll("."+this._selectors.classes.block)),a=!0,s=!1,n=void 0;try{for(var i,o=l[Symbol.iterator]();!(a=(i=o.next()).done);a=!0){var c=i.value;c.classList.remove(this._selectors.classes.block),c.classList.remove(this._selectors.classes.editable),c.classList.remove(this._selectors.classes.deletable),c.removeAttribute(this._selectors.attributes.allowedChildrenList),c.removeAttribute(this._selectors.attributes.blockType)}}catch(e){s=!0,n=e}finally{try{!a&&o.return&&o.return()}finally{if(s)throw n}}var u=Array.from(r.querySelectorAll("."+this._selectors.classes.hasChildren)),d=!0,h=!1,b=void 0;try{for(var v,f=u[Symbol.iterator]();!(d=(v=f.next()).done);d=!0)v.value.classList.remove(this._selectors.classes.hasChildren)}catch(e){h=!0,b=e}finally{try{!d&&f.return&&f.return()}finally{if(h)throw b}}return r.innerHTML}},{key:"prepareSaveData",value:function(){return BLRE.events.trigger("blre-html-persistance-serialize")}},{key:"loadFromData",value:function(e){var t=BLRE.events.trigger("blre-html-persistance-deserialize",{toLoad:e}),r=BluiBase.parseHtml(BLRE.events.trigger("blre-html-persistance-render-node-html",{blockId:t.globalId}));this._blockify(r),this._dom.innerHTML=r.outerHTML}},{key:"Save",value:function(){var e=this.prepareSaveData(),t=new FormData;return t.append("rescueFileData",e),BLRE.events.trigger("blre-async-io-save-editor-file",{fileData:t})}},{key:"Load",value:function(e){var t=this;return BLRE.events.trigger("blre-async-io-get-editor-file",{id:e}).then(function(e){t.loadFromData(e)})}},{key:"_blockify",value:function(e){var t=this,r=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],l=function(){return BluiBase.parseHtml('<a href="#" class="'+t._selectors.classes.addButton+'">+</a>')},a=Array.from(e.querySelectorAll("."+this._selectors.classes.block+":not("+this._selectors.classes.root+")"));a.unshift(e);var s=!0,n=!1,i=void 0;try{for(var o,c=a[Symbol.iterator]();!(s=(o=c.next()).done);s=!0){var u=o.value;u.classList.contains(this._selectors.classes.deletable)&&u.appendChild(BluiBase.parseHtml('<a href="#" class="'+t._selectors.classes.deleteButton+'">X</a>')),u.classList.contains(this._selectors.classes.editable)&&u.appendChild(BluiBase.parseHtml('<a href="#" class="'+t._selectors.classes.editButton+'">Edit</a>')),u.insertAdjacentHTML("beforebegin",l().outerHTML),u.classList.contains(this._selectors.classes.root)||u.appendChild(function(e){return BluiBase.parseHtml('<span class="'+t._selectors.classes.blockLabel+'">'+e+"</a>")}(u.getAttribute(this._selectors.attributes.blockType)))}}catch(e){n=!0,i=e}finally{try{!s&&c.return&&c.return()}finally{if(n)throw i}}var d=Array.from(e.querySelectorAll("."+this._selectors.classes.hasChildren));e.classList.contains(this._selectors.classes.hasChildren)&&d.unshift(e);var h=!0,b=!1,v=void 0;try{for(var f,m=d[Symbol.iterator]();!(h=(f=m.next()).done);h=!0)f.value.appendChild(l())}catch(e){b=!0,v=e}finally{try{!h&&m.return&&m.return()}finally{if(b)throw v}}if(!r){var p=e.previousElementSibling;p.parentNode.removeChild(p)}}},{key:"_extractGlobalId",value:function(e){return e.getAttribute("id").replace("blre-block-","")}},{key:"_getAddButtonIndex",value:function(e){var t=Array.from(e.parentNode.children),r=[],l=!0,a=!1,s=void 0;try{for(var n,i=t[Symbol.iterator]();!(l=(n=i.next()).done);l=!0){var o=n.value;o.classList.contains(this._selectors.classes.addButton)&&r.push(o)}}catch(e){a=!0,s=e}finally{try{!l&&i.return&&i.return()}finally{if(a)throw s}}return r.indexOf(e)}},{key:"_prepareEditFormValues",value:function(e){var t=[],r=Array.from(e.querySelectorAll("input, textarea")),l=!0,a=!1,s=void 0;try{for(var n,i=r[Symbol.iterator]();!(l=(n=i.next()).done);l=!0){var o=n.value,c="blre-form-input-get-value-"+o.getAttribute("type"),u=void 0;if(BLRE.events.exists(c)){var d=this._domData.get(this._dom)["blre-form-input-custom-data"];d.input=o,u=BLRE.events.trigger(c,d)}else u=o.value;t.push({name:o.getAttribute("name"),value:u})}}catch(e){a=!0,s=e}finally{try{!l&&i.return&&i.return()}finally{if(a)throw s}}return t}},{key:"_fireActionEvent",value:function(){if(BLRE.events.exists("blre-ui-action-happened"))BLRE.events.trigger("blre-ui-action-happened")}}]),t}();